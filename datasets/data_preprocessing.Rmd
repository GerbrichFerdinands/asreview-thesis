---
title: "R Notebook"
output:
  html_document:
    df_print: paged
---

```{r}
library(tidyverse)
template <- data.frame(search = rep(0,4), # papers obtained in systematic search
                       ftext = rep(0, 4), # number of abstract inclusions
                       incl = rep(0,4), # papers included in systematic review
                       row.names = c("paper", # numbers reported in the publication
                                     "raw", # numbers published on raw dataset
                                     "asreview",
                                     "test")) # numbers in test dataset asreview

# function to compute descriptives from dataset
data_descr <- function(data){
  return(c(nrow(data), # all papers obtained in the systematic search
           sum(data$inclusion_code > 0), # number of abstract inclusions
           sum(data$included))) # papers included in systematic review
}
```

This notebook processes all five systematic review datasets into datasets that can be used for testing asreview. 

## ace dataset 
```{r}
ace <- template
ace["paper", ] <- c(2544, NA, round(2544*0.0160)) 

# raw --------------------------------------------------------------------------
# original paper not to linked directly. cannot be retrieved? 
# checked dataset online by cohen et al. 
#https://dmice.ohsu.edu/cohenaa/systematic-drug-class-review-data.html
ace["raw", ] <- c(2544, NA, 41)

# asreview ---------------------------------------------------------------------
ace_asr <- read.csv("https://raw.github.com/asreview/systematic-review-datasets/master/datasets/Cohen_EBM/output/ACEInhibitors.csv",
                     header=T)

ace["asreview", ] <- c(nrow(ace_asr),
                       NA,
                       sum(ace_asr$label_included))
```

Create test dataset
```{r}
ace_test <- ace_asr %>%
  drop_na(abstract) %>% # drop entries with missing abstracts
  distinct(abstract, .keep_all = TRUE) # remove entries with duplicate abstracts

ace["test", ] <- c(nrow(ace_test),
                   NA,
                   sum(ace_test$label_included))
```


```{r}
# select columns
ace_test <- ace_test %>%
       select(authors, title, abstract, label_included) # select relevant columns

# save test file
write.csv(ace_test,
          "test_datasets/ace.csv")
```



## nudging dataset 
```{r}
# by Rosanna Nagtegaal
nudging <- template
nudging["paper", ] <- c(2006, 377, 100) 
```


```{r}
# data is not public yet
# raw
# asreview
```


## PTSD dataset
```{r}
ptsd <- template 
ptsd["paper", ] <- c(6185, 363, 34) # from flowchart 

# raw --------------------------------------------------------------------------
ptsd["raw", ] 

```

```{r}
# asreview ---------------------------------------------------------------------
ptsd_asr <- read.csv("https://raw.github.com/asreview/systematic-review-datasets/master/datasets/Van_de_Schoot_PTSD/output/PTSD_VandeSchoot_18.csv",
                     header=T)

ptsd["asreview", ] <- data_descr(ptsd_asr)
```

Now, remove duplicate entries and empty abstracts to arrive at test set. 
```{r}
ptsd_test <- ptsd_asr %>%
  drop_na(abstract) %>% # drop entries with missing abstracts
  distinct(abstract, .keep_all = TRUE)# remove entries with duplicate abstracts
``` 

There are 38 inclusions in this dataset, should be 34. 
Een vraag! De 'bayesian PTSD-trajectory analysis' kent 34 final inclusions. 
Voor (het quALITS paper dan, denk ik?) 38 inclusies waren. 
```{r}
# get rid of 4 extra inclusions (see log book)
drop_id <- 
  ptsd_test %>%
  filter(included == 1, 
         str_detect(authors, "Sterling, M., Hendrikz, J., Kenardy, J.") |
         str_detect(authors, "Hou") |
         str_detect(authors, "Mason") |
         str_detect(authors, "PÃ©rez")) %>%
  select(id)
drop_id <- drop_id$id

# get rid of 4 papers
ptsd_test <- ptsd_test[!(ptsd_test$id %in% drop_id), ] 
```

Save the test dataset.
```{r}
# finalize dataset and save 
ptsd_test <- ptsd_test %>%
            select(authors, title, abstract, included, inclusion_code) # select relevant columns
# save test file
write.csv(ptsd_test,
          "test_datasets/ptsd.csv")
```

Derive statistics in final test set.
```{r}
ptsd["test", ] <- data_descr(ptsd_test)
```

## software
```{r}
hall <- template
# or do it in the paper from the Yu et al study? yes. 
hall["paper", ] <- c(8911, NA, 104)

# raw --------------------------------------------------------------------------
h_raw <- read.csv("https://zenodo.org/record/1162952/files/Hall.csv",
                  header=T)

hall["raw", ] <- c(length(h_raw$Document.Title),
                   NA,
                   sum(h_raw$label == "yes"))
                          
# asreview ---------------------------------------------------------------------
hall_asr <- read.csv("https://raw.github.com/asreview/systematic-review-datasets/master/datasets/Four%20Software%20Engineer%20Data%20Sets/Software%20Engineering%201%20Hall.csv",
                     header=T)

hall["asreview", ] <- data_descr(hall_asr)


```

creating test dataset
```{r}
hall_test <- hall_asr %>%
   drop_na(abstract) %>% # drop entries with missing abstracts
   distinct(abstract, .keep_all = TRUE)# remove entries with duplicate abstracts
hall["test", ] <- data_descr(hall_test)

write.csv(hall_test , # select relevant columns
          "test_datasets/software.csv")
```

## wilson

```{r}
wilson <- template
wilson["paper", ] <- c(3453, 174, 26)

# raw --------------------------------------------------------------------------
# w_ftext <- read.delim("../datasets/raw/DOKU_All FT-Screening_20200116_cap.txt")
# w_incl <- read.csv("../datasets/raw/DOKU_All Included_20200116_cap.csv")
# w_all <- read.csv("../datasets/raw/DOKU_All TiAb-Screening_20200116_cap.csv")
# wilson["raw", ] <- c(nrow(w_all), nrow(w_ftext), nrow(w_incl))
wilson["raw", ] <- c(3453, 174, 26) # looked it up

w_asr <- read.csv("https://raw.github.com/asreview/systematic-review-datasets/master/datasets/Appenzeller-Herzog_Wilson/output/output_csv_wilson.csv",
                     header=T)

# inclusion_code label is not in there 
w_asr$inclusion_code <- w_asr$label_abstract_screening + w_asr$label_included
w_asr$included <- w_asr$label_included
wilson["asreview", ] <- data_descr(w_asr)

```

```{r}
# create test dataset
w_test <- w_asr %>%
  drop_na(abstract) %>% # drop entries with missing abstracts
  distinct(abstract, .keep_all = TRUE)# remove entries with duplicate abstracts

# select relevant columns
w_test <- w_test %>%
            select(authors, title, abstract, included, inclusion_code)

wilson["test",] <- data_descr(w_test)
```


Save the test dataset.
```{r}
# save test file
write.csv(w_test , # select relevant columns
          "test_datasets/wilson.csv")
```
```


# Save descriptive statistics 

```{r eval = TRUE}
# put everything together in list. 
all <- list(ace = ace,
            nudging = nudging,
            ptsd = ptsd,
            software = hall,
            wilson = wilson)

# save datafile, to serve as data for descriptive table in manuscript
save(all, file = "../manuscript/drafts/data/datasets_table.Rdata")
```

