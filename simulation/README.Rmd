---
title: "logbook simulations"
output:   
  md_document:
    variant: markdown_github
---

This is the log of simulations. 

# Simulations

## Hyperparameter optimization
There are three stages, we start with the first where we are comparing different classifiers. 

```{r include = FALSE}
library(tidyverse)
library(knitr)
library(kableExtra)
datasets <- c("ace", "ptsd", "nudging", "software", "wilson")
knitr::opts_chunk$set(echo = FALSE)
```

```{r}
conditiongrid <- readRDS("00_conditiongrid.RDS")

conditiongrid %>%
  kable(format = "markdown")
```

### Version information
Personal device: macos catalina 10.15.2

Cartesius supercomputer 
asreview 0.7.2
asreview simulation branch reorganization. 

-----

# Stage 1 - Classifiers 
Comparing five different classifiers
```{r}
hyperparametersets <- readRDS("01_hyperparameter_sets.RDS")

# to-do grid 
todo <- hyperparametersets

# set emojis for grid 
check <- function(todo, m, ho, d){
  todo[todo$model %in% m & todo$hyperopt == ho, d] <- emo::ji("check") 
  return(todo)
}

busy <- function(todo, m, ho, d){
  todo[todo$model %in% m & todo$hyperopt == ho, d] <- emo::ji("timer") 
  return(todo)
}

huh <- function(todo, m, ho, d){
  todo[todo$model %in% m & todo$hyperopt == ho, d] <- emo::ji("question") 
  return(todo)
}

not <- function(todo, m, ho, d){
  todo[todo$model %in% m & todo$hyperopt == ho, d] <- emo::ji("x") 
  return(todo)
}

```

R - 275 secs 119% - 5 datasets 
```{r}
275 / 5 * 1000 / 60 # 916 minutes
```

## 1.1 Optimizing (hyper)parameters per model, per dataset (1-1)
```{r}
lubridate::date("2020-03-17")
# i am working on svm model for all datasets 
todo <- busy(todo, "SCTW", "one", "ace")
```

Optimization run on Cartesius
```{bash, eval = FALSE}
# BCTW

# RCTW

# SCTW 
./cart_hyper_run.py hyper-active -t 12:00:00 -m svm -b double -e tfidf -q max -d ace -r 23 # job id 7768402

# LCTW

# NCTW
```

***

```{r}
lubridate::date("2020-03-18")
todo <- check(todo, "BCTW", "one", datasets)
todo <- check(todo, "SCTW", "one", "ace")
```

Store config files from job 7768402, SCTW model.

```{bash, eval = FALSE}
asreview create-config output/active/svm_max_double_tfidf/ace/trials.pkl -o config/SCTW_ace.ini
```

Transfer config files to my computer home directory 
```{bash, eval = FALSE}
# in own device. 
scp gerbrich@cartesius.surfsara.nl:asreview/config/SCTW_ace.ini ~
```

```{bash, eval = FALSE}
# BCTW
./cart_hyper_run.py hyper-active -t 03:00:00 -m nb -b double -e tfidf -q max -d ace -r 23 # 7772446
./cart_hyper_run.py hyper-active -t 03:00:00 -m nb -b double -e tfidf -q max -d nudging -r 23 # 7772450
./cart_hyper_run.py hyper-active -t 03:00:00 -m nb -b double -e tfidf -q max -d ptsd -r 23 # 7772452
./cart_hyper_run.py hyper-active -t 03:00:00 -m nb -b double -e tfidf -q max -d software -r 23 # 7772454
./cart_hyper_run.py hyper-active -t 03:00:00 -m nb -b double -e tfidf -q max -d wilson -r 23 # 7772456
# extract all trials.pkl files 
scp gerbrich@cartesius.surfsara.nl:asreview/output/active/nb_max_double_tfidf/ace/trials.pkl ~/hyperopt/trials/BCTW_ace.pkl 
scp gerbrich@cartesius.surfsara.nl:asreview/output/active/nb_max_double_tfidf/nudging/trials.pkl ~/hyperopt/trials/BCTW_nudging.pkl 
scp gerbrich@cartesius.surfsara.nl:asreview/output/active/nb_max_double_tfidf/ptsd/trials.pkl ~/hyperopt/trials/BCTW_ptsd.pkl
scp gerbrich@cartesius.surfsara.nl:asreview/output/active/nb_max_double_tfidf/software/trials.pkl ~/hyperopt/trials/BCTW_software.pkl 
scp gerbrich@cartesius.surfsara.nl:asreview/output/active/nb_max_double_tfidf/wilson/trials.pkl ~/hyperopt/trials/BCTW_wilson.pkl 
# create config files
asreview create-config trials/BCTW_ace.pkl -o config/BCTW_ace.ini
asreview create-config trials/BCTW_nudging.pkl -o config/BCTW_nudging.ini
asreview create-config trials/BCTW_ptsd.pkl -o config/BCTW_ptsd.ini
asreview create-config trials/BCTW_software.pkl -o config/BCTW_software.ini
asreview create-config trials/BCTW_wilson.pkl -o config/BCTW_wilson.ini

# RCTW

# SCTW 

# LCTW

# NCTW

```

***

```{r}
lubridate::date("2020-03-19")

#todo <- check(todo, "BCTW", "one", datasets)
```

### simulations with nb 
```{bash, eval = FALSE}
# create config files within cartesius (scripts folder)
asreview create-config output/active/nb_max_double_tfidf/ace/trials.pkl -o config/BCTW_ace.ini
asreview create-config output/active/nb_max_double_tfidf/nudging/trials.pkl  -o config/BCTW_nudging.ini
asreview create-config output/active/nb_max_double_tfidf/ptsd/trials.pkl  -o config/BCTW_ptsd.ini
asreview create-config output/active/nb_max_double_tfidf/software/trials.pkl  -o config/BCTW_software.ini
asreview create-config output/active/nb_max_double_tfidf/wilson/trials.pkl  -o config/BCTW_wilson.ini
```

```{bash, eval = FALSE}
# run simulations within cartesius
./cart_simulate.py data/ace.csv --config_file config/BCTW_ace.ini --state_file "simoutput/bctw/ace/BCTW_ace.h5" -r 23 

./cart_simulate.py data/nudging.csv --config_file config/BCTW_nudging.ini --state_file "simoutput/bctw/nudging/BCTW_nudging.h5" -r 23 

./cart_simulate.py data/ptsd.csv --config_file config/BCTW_ptsd.ini --state_file "simoutput/bctw/ptsd/BCTW_ptsd.h5" -r 23 

./cart_simulate.py data/software.csv --config_file config/BCTW_software.ini --state_file "simoutput/bctw/software/BCTW_software.h5" -r 23 

./cart_simulate.py data/wilson.csv --config_file config/BCTW_wilson.ini --state_file "simoutput/bctw/wilson/BCTW_wilson.h5" -r 23 
```

### extract simulation results nb 
```{bash}
# transfer files to device 
scp -r gerbrich@cartesius.surfsara.nl:asreview/simoutput /Users/gerbrich/Documents/MSBBSS/asreviewthesis/asreview-thesis/simulation_output
```

```{bash}
# on own device
asreview plot asreview-thesis/simulation_output
```

***
```{r}
lubridate::date("2020-03-22")
todo <- busy(todo, "SCTW", "one", datasets[2:5])
todo <- busy(todo, c("LCTW", "RCTW", "NCDW"), "one", "ace")
todo <- not(todo, "NCTW", "one", datasets)
# do the remaining datasets of svm, and one test run for L and one for R. 
```

Sent hyperparameters for optimization
```{bash, eval = FALSE}
# SCTW
./cart_hyper_run.py hyper-active -t 12:00:00 -m svm -b double -e tfidf -q max -d nudging -r 23 # 7805983
./cart_hyper_run.py hyper-active -t 12:00:00 -m svm -b double -e tfidf -q max -d ptsd -r 23 # 7805984
./cart_hyper_run.py hyper-active -t 12:00:00 -m svm -b double -e tfidf -q max -d software -r 23 # 7805985
./cart_hyper_run.py hyper-active -t 12:00:00 -m svm -b double -e tfidf -q max -d wilson -r 23 # 7805986

# LCTW 
./cart_hyper_run.py hyper-active -t 12:00:00 -m lr -b double -e tfidf -q max -d ace -r 23 # 7805987

# RCTW 
./cart_hyper_run.py hyper-active -t 12:00:00 -m rf -b double -e tfidf -q max -d ace -r 23 # 7805989

# NCTW does not work well with tfidf, save for second round with doc2vec: 
# NCDW
./cart_hyper_run.py hyper-active -t 12:00:00 -m nn-2-layer -b double -e doc2vec -q max -d ace -r 23 # 7806021

```

***
```{r}
lubridate::date("2020-03-23")
todo <- check(todo, "SCTW", "one", datasets[3:5])
```

Resimulate BCTW models.
 - create-config file from trials.pkl: n_instances 20, 1/1
 - how to overrule this parameters? (not possible through cli) 
 
```{bash, eval = FALSE}
./cart_simulate.py data/ace.csv --config_file config/BCTW_ace.ini --state_file "simoutput/bctw/ace/results_ace.h5" -r 23 
./cart_simulate.py data/nudging.csv --config_file config/BCTW_nudging.ini --state_file "simoutput/bctw/nudging/results_nudging.h5" -r 23 
./cart_simulate.py data/ptsd.csv --config_file config/BCTW_ptsd.ini --state_file "simoutput/bctw/ptsd/results_ptsd.h5" -r 23 
./cart_simulate.py data/software.csv --config_file config/BCTW_software.ini --state_file "simoutput/bctw/software/results_software.h5" -r 23 
./cart_simulate.py data/wilson.csv --config_file config/BCTW_wilson.ini --state_file "simoutput/bctw/wilson/results_wilson.h5" -r 23 
```

Process BCTW models into table
 - python script to extract statistics
 - 

Checkout hyperopt SCTW
Nudging dataset doesn't optimize well? 
```{r}
todo <- huh(todo, "SCTW", "one", "nudging")
```

Checkout results first hyperopt: 
LCTW - no output?? 
RCTW - only 'current'
```{r}
todo <- huh(todo, c("LCTW", "RCTW"), "one", "ace")
```

NCDW - loss still going down, sent in for another 12 hours. 
```{bash, eval = FALSE}
./cart_hyper_run.py hyper-active -t 12:00:00 -m nn-2-layer -b double -e doc2vec -q max -d ace -r 23 # 7811926
```

(re)Simulate BCTW models
Simulate SCTW models 

***

```{r}
lubridate::date("2020-03-24")
# todo <- busy(todo, "SCTW", "one", datasets[2:5])
```

Process SCTW models into table

Simulate LCTW, RCTW and NCTW models 

Create a nice plot 

Send first version of table

***

```{r}
# save the to-do grid in markdown style
todo[todo==0] <- emo::ji("white square button")
todo %>% kable(format = "markdown")

saveRDS(todo %>% kable(format = "markdown"), 
        file = "02_todo_hp.RDS")
```

## Stage 2 - Feature extraction 
Comparing tfidf with doc2vec

## Stage 3 - Balance strategy
Redo all the analyses with a different balance strategy (aggressive undersampling?)
Probably won't have time for this. 


# The data 
On 17 march 2020: 

```
************  ace.csv  ************

Number of papers:            2235
Number of inclusions:        41 (1.83%)
Number of exclusions:        2194 (98.17%)
Number of unlabeled:         0 (0.00%)
Average title length:        123
Average abstract length:     1623
Number of missing titles:    0 (of which 0 included)
Number of missing abstracts: 0 (of which 0 included)


************  nudging.csv  ************

Number of papers:            1847
Number of inclusions:        100 (5.41%)
Number of exclusions:        1747 (94.59%)
Number of unlabeled:         0 (0.00%)
Average title length:        109
Average abstract length:     1831
Number of missing titles:    0 (of which 0 included)
Number of missing abstracts: 0 (of which 0 included)


************  ptsd.csv  ************

Number of papers:            5031
Number of inclusions:        38 (0.76%)
Number of exclusions:        4993 (99.24%)
Number of unlabeled:         0 (0.00%)
Average title length:        104
Average abstract length:     1537
Number of missing titles:    1 (of which 0 included)
Number of missing abstracts: 0 (of which 0 included)


************  software.csv  ************

Number of papers:            8896
Number of inclusions:        104 (1.17%)
Number of exclusions:        8792 (98.83%)
Number of unlabeled:         0 (0.00%)
Average title length:        81
Average abstract length:     896
Number of missing titles:    0 (of which 0 included)
Number of missing abstracts: 0 (of which 0 included)


************  wilson.csv  ************

Number of papers:            2333
Number of inclusions:        23 (0.99%)
Number of exclusions:        2310 (99.01%)
Number of unlabeled:         0 (0.00%)
Average title length:        83
Average abstract length:     1325
Number of missing titles:    1 (of which 0 included)
Number of missing abstracts: 0 (of which 0 included)
```
